<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LeetCode Question Recommender</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <link
      rel="shortcut icon"
      href="{{ url_for('static', filename='question.png') }}"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f7f9fc;
      }
      .tag-button,
      .difficulty-button {
        transition: background-color 0.3s ease, color 0.3s ease;
      }
      .tag-button:hover,
      .difficulty-button:hover {
        transform: scale(1.05);
      }
      .pagination-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 0.5rem;
        margin-bottom: 2rem;
      }
      @media (max-width: 640px) {
        .container {
          padding-left: 0.5rem;
          padding-right: 0.5rem;
        }
        .question-item {
          padding: 0.75rem;
        }
        .tag-container {
          margin-top: 0.5rem;
        }
        .question-title {
          font-size: 1rem;
        }
      }
    </style>
  </head>
  <body>
    <div id="app" class="container mx-auto p-4 max-w-4xl">
      <div class="bg-white shadow-lg rounded-lg p-6 mb-8">
        <div class="flex justify-between items-center mb-6">
          <h1 class="text-3xl font-bold text-gray-800">LeetCode Recommender</h1>
          <button
            @click="getRecommendation"
            class="bg-[#3c4859] hover:bg-[#2c3849] text-white font-semibold px-4 py-2 rounded-lg transition duration-300 ease-in-out transform hover:scale-105"
          >
            Get Recommendation
          </button>
        </div>

        <div
          v-if="recommendedQuestion && !allCompleted"
          class="mt-4 bg-[#e7f3ff] border-l-4 border-[#3c4859] p-4 rounded-r-lg"
        >
          <h3 class="text-lg font-semibold text-[#3c4859] mb-2">
            Recommended Question:
          </h3>
          <div class="flex items-center justify-between">
            <a
              :href="recommendedQuestion.url"
              target="_blank"
              class="text-[#3c4859] hover:underline text-lg"
            >
              [[ recommendedQuestion.name ]] (#[[ recommendedQuestion.id ]])
            </a>
            <input
              type="checkbox"
              :id="'rec-' + recommendedQuestion.id"
              v-model="recommendedQuestion.completed"
              @change="updateProgress(recommendedQuestion)"
              class="h-5 w-5 text-[#3c4859] focus:ring-[#3c4859] border-gray-300 rounded"
            />
          </div>
          <p class="text-sm text-gray-600">
            Difficulty: [[ recommendedQuestion.difficulty ]]
          </p>
          <p class="text-sm text-gray-600">
            Tags: [[ recommendedQuestion.tags.join(', ') ]]
          </p>
        </div>

        <div
          v-if="allCompleted"
          class="mt-4 bg-green-100 border-l-4 border-green-500 p-4 rounded-r-lg"
        >
          <p class="text-xl font-bold text-green-800 mb-2">Good job!</p>
          <button
            @click="resetProgress"
            class="bg-[#ffa116] hover:bg-[#ff9006] text-white font-semibold px-4 py-2 rounded-lg transition duration-300 ease-in-out transform hover:scale-105"
          >
            Practice again?
          </button>
        </div>

        <div class="mb-6 flex flex-wrap">
          <button
            v-for="company in companies"
            :key="company"
            @click="selectCompany(company)"
            :class="['px-4 py-2 mr-2 mb-2 rounded-lg font-semibold transition duration-300 ease-in-out', 
                                 selectedCompany === company ? 'bg-[#3c4859] text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300']"
          >
            [[ company ]]
          </button>
        </div>

        <form @submit.prevent="searchQuestions" class="mb-4">
          <div class="flex">
            <input
              type="text"
              v-model="searchQuery"
              placeholder="Search questions..."
              class="flex-grow px-4 py-2 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-[#3c4859]"
            />
            <button
              type="submit"
              class="bg-[#3c4859] hover:bg-[#2c3849] text-white font-semibold px-4 py-2 rounded-r-lg transition duration-300 ease-in-out"
            >
              Search
            </button>
          </div>
        </form>
      </div>

      <div
        v-if="questions.length > 0"
        class="bg-white shadow-lg rounded-lg p-6 mb-8"
      >
        <h2 class="text-2xl font-semibold mb-4 text-gray-800">
          Questions for [[ selectedCompany ]]
        </h2>
        <ul class="space-y-4">
          <li
            v-for="question in questions"
            :key="question.id"
            class="question-item flex flex-col p-4 rounded-lg transition duration-300 ease-in-out"
            :class="{
                'bg-green-50': question.completed && question.difficulty === 'Easy',
                'bg-yellow-50': question.completed && question.difficulty === 'Medium',
                'bg-red-50': question.completed && question.difficulty === 'Hard',
                'bg-gray-50 hover:bg-gray-100': !question.completed
            }"
          >
            <div class="flex flex-wrap justify-between items-center">
              <a
                :href="question.url"
                target="_blank"
                class="question-title text-gray-800 hover:text-[#3c4859] hover:underline font-semibold text-lg mb-2 sm:mb-0 flex-grow"
              >
                [[ question.name ]] (#[[ question.id ]])
              </a>
              <input
                type="checkbox"
                :id="question.id"
                v-model="question.completed"
                @change="updateProgress(question)"
                class="h-5 w-5 text-[#3c4859] focus:ring-[#3c4859] border-gray-300 rounded ml-2"
              />
            </div>
            <div class="tag-container mt-2 flex flex-wrap gap-2">
              <button
                @click="toggleDifficultyFilter(question.difficulty)"
                class="difficulty-button inline-block px-3 py-1 rounded-full text-sm font-medium"
                :class="{
                        'bg-green-100 text-green-800': question.difficulty === 'Easy',
                        'bg-yellow-100 text-yellow-800': question.difficulty === 'Medium',
                        'bg-red-100 text-red-800': question.difficulty === 'Hard',
                        'ring-2 ring-offset-2': selectedDifficulties.includes(question.difficulty)
                    }"
              >
                [[ question.difficulty ]]
              </button>
              <button
                v-for="tag in question.tags"
                :key="tag"
                @click="toggleTagFilter(tag)"
                :class="['tag-button inline-block px-3 py-1 rounded-full text-sm font-medium', 
                                         selectedTags.includes(tag) ? 'bg-[#3c4859] text-white' : 'bg-gray-200 text-gray-700']"
              >
                [[ tag ]]
              </button>
            </div>
          </li>
        </ul>
      </div>

      <div
        v-if="totalPages > 1"
        class="flex flex-wrap justify-center items-center gap-2 mb-8"
      >
        <button
          @click="changePage(currentPage - 1)"
          :disabled="currentPage === 1"
          class="px-3 py-1 rounded-md font-semibold transition duration-300 ease-in-out"
          :class="currentPage === 1 ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'"
        >
          <i class="fas fa-chevron-left"></i>
        </button>
        <button
          v-for="page in displayedPages"
          :key="page"
          @click="page !== '...' && changePage(page)"
          :class="['px-3 py-1 rounded-md font-semibold transition duration-300 ease-in-out', 
                         page === '...' ? 'cursor-default' : (currentPage === page ? 'bg-[#3c4859] text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300')]"
        >
          [[ page ]]
        </button>
        <button
          @click="changePage(currentPage + 1)"
          :disabled="currentPage === totalPages"
          class="px-3 py-1 rounded-md font-semibold transition duration-300 ease-in-out"
          :class="currentPage === totalPages ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'"
        >
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>

      <footer class="text-center py-4 bg-white shadow-lg rounded-lg">
        <p class="text-gray-700">Made by üêº</p>
        <p class="text-gray-600">
          Like what you see? Find me on
          <a
            href="https://www.linkedin.com/in/anishpanda/"
            target="_blank"
            class="text-[#3c4859] hover:underline"
            >LinkedIn</a
          >
        </p>
      </footer>
    </div>

    <script>
      const { createApp, ref, onMounted, computed, watch } = Vue;

      createApp({
        delimiters: ["[[", "]]"],
        setup() {
          const companies = ref([]);
          const selectedCompany = ref("");
          const questions = ref([]);
          const recommendedQuestion = ref(null);
          const allCompleted = ref(false);
          const currentPage = ref(1);
          const totalPages = ref(1);
          const selectedTags = ref([]);
          const searchQuery = ref("");
          const selectedDifficulties = ref([]);

          const selectCompany = async (company) => {
            selectedCompany.value = company;
            currentPage.value = 1;
            selectedTags.value = [];
            searchQuery.value = "";
            await fetchQuestions();
          };

          const toggleDifficultyFilter = async (difficulty) => {
            const index = selectedDifficulties.value.indexOf(difficulty);
            if (index > -1) {
              selectedDifficulties.value.splice(index, 1);
            } else {
              selectedDifficulties.value.push(difficulty);
            }
            currentPage.value = 1;
            await fetchQuestions();
          };

          const fetchQuestions = async () => {
            let url = `/questions/${selectedCompany.value}?page=${currentPage.value}`;
            if (selectedTags.value.length > 0) {
              url += `&tag=${selectedTags.value.join(",")}`;
            }
            if (selectedDifficulties.value.length > 0) {
              url += `&difficulty=${selectedDifficulties.value.join(",")}`;
            }
            if (searchQuery.value) {
              url += `&search=${encodeURIComponent(searchQuery.value)}`;
            }
            const response = await fetch(url);
            const data = await response.json();
            questions.value = data.questions;
            totalPages.value = data.total_pages;
            currentPage.value = data.current_page;
            checkAllCompleted();
          };

          const changePage = async (page) => {
            currentPage.value = page;
            await fetchQuestions();
          };

          const displayedPages = computed(() => {
            const delta = 2;
            const range = [];
            for (
              let i = Math.max(1, currentPage.value - delta);
              i <= Math.min(totalPages.value, currentPage.value + delta);
              i++
            ) {
              range.push(i);
            }
            if (range[0] > 1) {
              if (range[0] > 2) {
                range.unshift("...");
              }
              range.unshift(1);
            }
            if (range[range.length - 1] < totalPages.value) {
              if (range[range.length - 1] < totalPages.value - 1) {
                range.push("...");
              }
              range.push(totalPages.value);
            }
            return range;
          });

          const updateProgress = async (question) => {
            await fetch("/update_progress", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                company: selectedCompany.value,
                questionId: question.id,
                completed: question.completed,
              }),
            });
            if (
              recommendedQuestion.value &&
              recommendedQuestion.value.id === question.id
            ) {
              recommendedQuestion.value.completed = question.completed;
            }
            // Update the question in the list
            const index = questions.value.findIndex(
              (q) => q.id === question.id
            );
            if (index !== -1) {
              questions.value[index].completed = question.completed;
            }
            checkAllCompleted();
          };

          const toggleTagFilter = async (tag) => {
            const index = selectedTags.value.indexOf(tag);
            if (index > -1) {
              selectedTags.value.splice(index, 1);
            } else {
              selectedTags.value.push(tag);
            }
            currentPage.value = 1;
            await fetchQuestions();
          };

          const getRecommendation = async () => {
            const response = await fetch(
              `/recommend_question?company=${selectedCompany.value}`
            );
            const data = await response.json();
            recommendedQuestion.value = data.message ? null : data;
          };

          const resetProgress = async () => {
            await fetch("/reset_progress", { method: "POST" });
            await selectCompany(selectedCompany.value);
            allCompleted.value = false;
            recommendedQuestion.value = null;
          };

          const checkAllCompleted = () => {
            allCompleted.value =
              questions.value.length > 0 &&
              questions.value.every((q) => q.completed);
          };

          const searchQuestions = async () => {
            currentPage.value = 1;
            selectedTags.value = [];
            await fetchQuestions();
          };

          onMounted(async () => {
            const response = await fetch("/");
            const html = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, "text/html");
            companies.value = JSON.parse(
              doc.getElementById("companies-data").textContent
            );
            if (companies.value.length > 0) {
              selectCompany(companies.value[0]);
            }
          });

          return {
            companies,
            selectedCompany,
            questions,
            recommendedQuestion,
            allCompleted,
            currentPage,
            totalPages,
            selectedTags,
            searchQuery,
            selectedDifficulties,
            displayedPages,
            selectCompany,
            changePage,
            updateProgress,
            toggleTagFilter,
            getRecommendation,
            resetProgress,
            searchQuestions,
            toggleDifficultyFilter,
          };
        },
      }).mount("#app");
    </script>
    <script id="companies-data" type="application/json">
      {{ companies | tojson | safe }}
    </script>
  </body>
</html>
